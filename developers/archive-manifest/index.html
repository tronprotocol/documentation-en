<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://tronprotocol.github.io/documentation-en/developers/archive-manifest/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Leveldb Startup Optimization Plugins - java-tron</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Leveldb Startup Optimization Plugins";
        var mkdocs_page_input_path = "developers/archive-manifest.md";
        var mkdocs_page_url = "/documentation-en/developers/archive-manifest/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> java-tron
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Getting Started</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started_with_javatron/">Getting Started with java-tron</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Using java-tron</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/installing_javatron/">Deploying java-tron</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/backup_restore/">Backup & Restore</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../litefullnode/">Lite FullNode</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/private_network/">Private Network</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/event/">Event Subscription</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/database/">Database Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/connecting_to_tron/">Network Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/metrics/">Node Monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/toolkit/">Node Maintenance Tool</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/http/">HTTP API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/rpc/">gRPC API</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Core Protocol</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../introduction/dpos/">DPoS</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../mechanism-algorithm/sr/">Super Representative</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../mechanism-algorithm/account/">Account Model</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../mechanism-algorithm/resource/">Resource Model</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../contracts/contract/">Smart Contract</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../mechanism-algorithm/system-contracts/">System Contract</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../mechanism-algorithm/dex/">Decentralized Exchange</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../mechanism-algorithm/multi-signatures/">Account Permission Management</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">For Java-tron Developers</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../java-tron/">Developer Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tips/">TIPs Workflow</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../issue-workflow/">Issue Workflow</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../governance/">Governance Workflow</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../run-in-idea/">Configure the IDE</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../demo/">Development Example</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../code-structure/">Core Modules</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">For DAPP developers</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../contracts/compiler/">Dapp Development Tool</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Wallet-cli</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../clients/wallet-cli/">What is Wallet-CLI</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../clients/wallet-cli-command/">Wallet Commands</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Releases</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../releases/upgrade-instruction/">Deployment Manual for the New Version</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../releases/signature_verification/">Integrity Check</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../releases/history/">History</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">java-tron</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li><li>Leveldb Startup Optimization Plugins</li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://github.com/tronprotocol/documentation-en/edit/master/docs/developers/archive-manifest.md"
          class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="leveldb-startup-optimization-plugins">Leveldb Startup Optimization Plugins<a class="headerlink" href="#leveldb-startup-optimization-plugins" title="Permanent link">&para;</a></h1>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>With the operation of levelDB, manifest file will continue to grow, huge manifest file not only affects the node startup speed, but also may cause the problem of system exit with continuous memory growth.
For this reason, leveldb startup optimization plugin is introduced since <code>GreatVoyage-v4.3.0(Bacon)</code>, which optimizes the file size of manifest and the startup process of LevelDB, reduces the memory occupation and improves the node startup speed.</p>
<p>Remember stop the FullNode process before any operation. This tool provides the ability to reformat the manifest according to the current <code>database</code>.</p>
<p>For more design details, please refer to: <a href="https://github.com/tronprotocol/tips/issues/298">TIP298</a>.</p>
<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">&para;</a></h2>
<h3 id="options-for-plug-in">Options For Plug-in<a class="headerlink" href="#options-for-plug-in" title="Permanent link">&para;</a></h3>
<ul>
<li><code>-b | --batch-size</code>: [ int ]  specify the batch manifest size,default：80000.</li>
<li><code>-d | --database-directory</code>: [ string ]  Specify the database directory to be processed,default：output-directory/database.</li>
<li><code>-m | --manifest-size</code>: [ int ] Specify the minimum required manifest file size ，unit:M，default：0.</li>
<li><code>-h | --help</code>: [ bool ]  for usage help，default：false.</li>
</ul>
<h3 id="how-to-get">How to get<a class="headerlink" href="#how-to-get" title="Permanent link">&para;</a></h3>
<ul>
<li>build by yourself.
  Under java-tron, execute <code>. /gradlew build</code>, you can get Toolkit.jar under <code>build/libs/</code>.</li>
<li>Download directly.
  <a href="https://github.com/tronprotocol/java-tron/releases">Links</a></li>
</ul>
<h3 id="use-steps">Use Steps<a class="headerlink" href="#use-steps" title="Permanent link">&para;</a></h3>
<ul>
<li>
<ol>
<li>Stop the FullNode service.</li>
</ol>
</li>
<li>
<ol>
<li>Execute the Toolkit command.</li>
</ol>
</li>
<li>
<ol>
<li>Start the FullNode service.</li>
</ol>
</li>
</ul>
<blockquote>
<p>Note: <code>Step ii</code> is not required every time, but it is recommended to run it every time to optimize the experience.</p>
</blockquote>
<h3 id="how-to-use">How to use<a class="headerlink" href="#how-to-use" title="Permanent link">&para;</a></h3>
<p>After FullNode runs, the default database directory: <code>output-directory</code>, the optimization plugin will work with the <code>output-directory/database</code> directory.
Developers can choose one of the following two ways  according to actual situation.</p>
<h4 id="use-it-independently">Use it Independently<a class="headerlink" href="#use-it-independently" title="Permanent link">&para;</a></h4>
<h5 id="1stop-the-fullnode-service">1.Stop the FullNode service<a class="headerlink" href="#1stop-the-fullnode-service" title="Permanent link">&para;</a></h5>
<p>Use <code>kill -15</code> to shutdown the FullNode.jar .</p>
<p>Query the pid: <code>ps -ef |grep FullNode.jar |grep -v grep |awk '{print $2}'</code></p>
<h5 id="2execute-the-toolkit-command">2.Execute the Toolkit command<a class="headerlink" href="#2execute-the-toolkit-command" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="c1"># Full command</span>
java<span class="w"> </span>-jar<span class="w"> </span>Toolkit.jar<span class="w"> </span><span class="o">[</span>-b<span class="w"> </span>batchSize<span class="o">]</span><span class="w"> </span><span class="o">[</span>-d<span class="w"> </span>databaseDirectory<span class="o">]</span><span class="w"> </span><span class="o">[</span>-m<span class="w"> </span>manifestSize<span class="o">]</span><span class="w"> </span><span class="o">[</span>-h<span class="o">]</span>
<span class="c1"># examples</span>
<span class="w">   </span>java<span class="w"> </span>-jar<span class="w"> </span>Toolkit.jar<span class="w"> </span><span class="c1">#1. use default settings</span>
<span class="w">   </span>java<span class="w"> </span>-jar<span class="w"> </span>Toolkit.jar<span class="w"> </span>-d<span class="w"> </span>/tmp/db/database<span class="w"> </span><span class="c1">#2. Specify the database directory as /tmp/db/database</span>
<span class="w">   </span>java<span class="w"> </span>-jar<span class="w"> </span>Toolkit.jar<span class="w"> </span>-b<span class="w"> </span><span class="m">64000</span><span class="w"> </span><span class="c1">#3. Specify the batch size to 64000 when optimizing Manifest</span>
<span class="w">   </span>java<span class="w"> </span>-jar<span class="w"> </span>Toolkit.jar<span class="w"> </span>-m<span class="w"> </span><span class="m">128</span><span class="w"> </span><span class="c1">#4. Specify optimization only when Manifest exceeds 128M</span>
</code></pre></div>
<p>After the command is executed, <code>archive.log</code> will be generated in the <code>./logs</code> directory, you can see the result.</p>
<blockquote>
<p>Note: After the command is executed，If successful, the log will display something similar to the following,
and will run generally within 120s, depending on how long the FullNode service keeps running,
and if it fails there will be a corresponding error message</p>
<p><code>[main] [archive](ArchiveManifest.java:144) DatabaseDirectory:output-directory/database, maxManifestSize:0, maxBatchSize:80000,database reopen use 80 seconds total.</code></p>
</blockquote>
<h5 id="3start-the-fullnode-service">3.Start the FullNode service<a class="headerlink" href="#3start-the-fullnode-service" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="c1">#FullNode</span>
nohup<span class="w"> </span>java<span class="w"> </span>-Xmx24g<span class="w"> </span>-XX:+UseConcMarkSweepGC<span class="w"> </span>-jar<span class="w"> </span>FullNode.jar<span class="w"> </span>-c<span class="w"> </span>main_net_config.conf<span class="w"> </span>&lt;/dev/null<span class="w"> </span><span class="p">&amp;</span>&gt;/dev/null<span class="w"> </span><span class="p">&amp;</span>
<span class="w"> </span><span class="c1">#SR Node</span>
nohup<span class="w"> </span>java<span class="w"> </span>-Xmx24g<span class="w"> </span>-XX:+UseConcMarkSweepGC<span class="w">  </span>-jar<span class="w"> </span>FullNode.jar<span class="w">  </span>-p<span class="w">  </span>private<span class="w"> </span>key<span class="w"> </span>--witness<span class="w"> </span>-c<span class="w"> </span>main_net_config.conf<span class="w"> </span>&lt;/dev/null<span class="w"> </span><span class="p">&amp;</span>&gt;/dev/null<span class="w"> </span><span class="p">&amp;</span>
</code></pre></div>
<h4 id="integrated-startup-script">Integrated startup script<a class="headerlink" href="#integrated-startup-script" title="Permanent link">&para;</a></h4>
<p><div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="nv">APP</span><span class="o">=</span><span class="nv">$1</span>

<span class="nv">MANIFEST_OPT</span><span class="o">=</span><span class="nv">$2</span>

<span class="nv">ALL_OPT</span><span class="o">=</span><span class="nv">$*</span>

<span class="nv">NEED_REBUILD</span><span class="o">=</span><span class="m">0</span>

<span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;--rewrite--manifest&#39;</span><span class="w"> </span><span class="o">]]</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">   </span><span class="nv">APP</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">   </span><span class="nv">NEED_REBUILD</span><span class="o">=</span><span class="m">1</span>

<span class="w"> </span><span class="k">elif</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;--rewrite--manifest&#39;</span><span class="w"> </span><span class="o">]]</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">   </span><span class="nv">NEED_REBUILD</span><span class="o">=</span><span class="m">1</span>
<span class="w"> </span><span class="k">fi</span>


rebuildManifest<span class="o">()</span><span class="w"> </span><span class="o">{</span>

<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$NEED_REBUILD</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">   </span>buildManifest
<span class="w"> </span><span class="k">fi</span>

<span class="o">}</span>


buildManifest<span class="o">()</span><span class="w"> </span><span class="o">{</span>

<span class="w"> </span><span class="nv">ARCHIVE_JAR</span><span class="o">=</span><span class="s1">&#39;Toolkit.jar&#39;</span>

<span class="w"> </span>java<span class="w"> </span>-jar<span class="w"> </span><span class="nv">$ARCHIVE_JAR</span><span class="w"> </span><span class="nv">$ALL_OPT</span>

<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>

<span class="w">     </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;rebuild manifest success&#39;</span>

<span class="w"> </span><span class="k">else</span>

<span class="w">     </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;rebuild manifest fail, log in logs/archive.log&#39;</span>

<span class="w"> </span><span class="k">fi</span>

<span class="o">}</span>



<span class="nv">APP</span><span class="o">=</span><span class="si">${</span><span class="nv">APP</span><span class="k">:-</span><span class="s2">&quot;FullNode&quot;</span><span class="si">}</span>

<span class="nv">START_OPT</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span><span class="w"> </span><span class="si">${</span><span class="p">@:</span><span class="nv">2</span><span class="si">}</span><span class="sb">`</span>

<span class="nv">JAR_NAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$APP</span><span class="s2">.jar&quot;</span>

<span class="nv">MAX_STOP_TIME</span><span class="o">=</span><span class="m">60</span>

<span class="nv">MEM_OPT</span><span class="o">=</span><span class="s1">&#39;&#39;</span>





checkpid<span class="o">()</span><span class="w"> </span><span class="o">{</span>

<span class="w"> </span><span class="nv">pid</span><span class="o">=</span><span class="sb">`</span>ps<span class="w"> </span>-ef<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="nv">$JAR_NAME</span><span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>-v<span class="w"> </span>grep<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span>

<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nv">$pid</span>

<span class="o">}</span>

checkPath<span class="o">(){</span>
<span class="w">  </span><span class="nv">path</span><span class="o">=</span><span class="s1">&#39;output-directory/database&#39;</span>
<span class="w">  </span><span class="nv">flag</span><span class="o">=</span><span class="m">1</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span>p<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="si">${</span><span class="nv">ALL_OPT</span><span class="si">}</span>
<span class="w">  </span><span class="k">do</span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$flag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">path</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$p</span><span class="sb">`</span>
<span class="w">        </span><span class="k">break</span>
<span class="w">     </span><span class="k">fi</span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;-d&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nv">$p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;--database-directory&#39;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">path</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">        </span><span class="nv">flag</span><span class="o">=</span><span class="m">0</span>
<span class="w">     </span><span class="k">fi</span>
<span class="w">  </span><span class="k">done</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">     </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;-d /path or --database-directory /path&#39;</span>
<span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-d<span class="w"> </span><span class="si">${</span><span class="nv">path</span><span class="si">}</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$path</span><span class="w"> </span><span class="s1">&#39;not exist&#39;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="k">fi</span>
<span class="o">}</span>



stopService<span class="o">()</span><span class="w"> </span><span class="o">{</span>

<span class="w">  </span><span class="nv">count</span><span class="o">=</span><span class="m">1</span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$count</span><span class="w"> </span>-le<span class="w"> </span><span class="nv">$MAX_STOP_TIME</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>

<span class="w">    </span>checkpid

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$pid</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>

<span class="w">       </span><span class="nb">kill</span><span class="w"> </span>-15<span class="w"> </span><span class="nv">$pid</span>

<span class="w">       </span>sleep<span class="w"> </span><span class="m">1</span>

<span class="w">    </span><span class="k">else</span>

<span class="w">       </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;java-tron stop&quot;</span>

<span class="w">       </span><span class="k">return</span>

<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nv">count</span><span class="o">=</span>$<span class="o">[</span><span class="nv">$count</span>+1<span class="o">]</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$count</span><span class="w"> </span>-eq<span class="w"> </span><span class="nv">$MAX_STOP_TIME</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>

<span class="w">      </span><span class="nb">kill</span><span class="w"> </span>-9<span class="w"> </span><span class="nv">$pid</span>

<span class="w">      </span>sleep<span class="w"> </span><span class="m">1</span>

<span class="w">    </span><span class="k">fi</span>

<span class="w">  </span><span class="k">done</span>

<span class="o">}</span>

startService<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="sb">`</span>date<span class="sb">`</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>start.log

<span class="w"> </span><span class="nv">total</span><span class="o">=</span><span class="m">16</span>*1024*1024

<span class="w"> </span><span class="nv">xmx</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$total</span><span class="s2">/1024/1024*0.6&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>bc<span class="w"> </span><span class="p">|</span>awk<span class="w"> </span>-F.<span class="w"> </span><span class="s1">&#39;{print $1&quot;g&quot;}&#39;</span><span class="sb">`</span>

<span class="w"> </span><span class="nv">directmem</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$total</span><span class="s2">/1024/1024*0.1&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>bc<span class="w"> </span><span class="p">|</span>awk<span class="w"> </span>-F.<span class="w"> </span><span class="s1">&#39;{print $1&quot;g&quot;}&#39;</span><span class="sb">`</span>

<span class="w"> </span><span class="nv">logtime</span><span class="o">=</span><span class="sb">`</span>date<span class="w"> </span>+%Y-%m-%d_%H-%M-%S<span class="sb">`</span>

<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">LD_PRELOAD</span><span class="o">=</span><span class="s2">&quot;/usr/lib64/libtcmalloc.so&quot;</span>

<span class="w">  </span>nohup<span class="w"> </span>java<span class="w"> </span>-Xms<span class="nv">$xmx</span><span class="w"> </span>-Xmx<span class="nv">$xmx</span><span class="w"> </span>-XX:+UseConcMarkSweepGC<span class="w"> </span>-XX:+PrintGCDetails<span class="w"> </span>-Xloggc:./gc.log<span class="se">\</span>
<span class="w">  </span>-XX:+PrintGCDateStamps<span class="w"> </span>-XX:+CMSParallelRemarkEnabled<span class="w"> </span>-XX:ReservedCodeCacheSize<span class="o">=</span>256m<span class="w"> </span>-XX:+UseCodeCacheFlushing<span class="se">\</span>
<span class="w">  </span><span class="nv">$MEM_OPT</span><span class="w"> </span>-XX:MaxDirectMemorySize<span class="o">=</span><span class="nv">$directmem</span><span class="w"> </span>-XX:+HeapDumpOnOutOfMemoryError<span class="w"> </span>-jar<span class="w"> </span><span class="nv">$JAR_NAME</span><span class="w"> </span><span class="nv">$START_OPT</span><span class="w"> </span>-c<span class="w"> </span>config.conf<span class="w">  </span>&gt;&gt;<span class="w"> </span>start.log<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">&amp;</span>

<span class="w"> </span><span class="nv">pid</span><span class="o">=</span><span class="sb">`</span>ps<span class="w"> </span>-ef<span class="w"> </span><span class="p">|</span>grep<span class="w"> </span><span class="nv">$JAR_NAME</span><span class="w"> </span><span class="p">|</span>grep<span class="w"> </span>-v<span class="w"> </span>grep<span class="w"> </span><span class="p">|</span>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span>

<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;start java-tron with pid </span><span class="nv">$pid</span><span class="s2"> on </span><span class="nv">$HOSTNAME</span><span class="s2">&quot;</span>

<span class="o">}</span>

<span class="c1">#1.Stop the FullNode service</span>
stopService

checkPath

<span class="c1">#2.Execute the Toolkit plugin</span>
<span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">0</span><span class="w"> </span><span class="o">==</span><span class="w">  </span><span class="nv">$?</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w"> </span>rebuildManifest
<span class="k">else</span>
<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>-1
<span class="k">fi</span>

sleep<span class="w"> </span><span class="m">5</span>
<span class="c1"># Start the FullNode service</span>
startService
</code></pre></div>
 example</p>
<blockquote>
<p>Note: Save above script as start.sh,  In the above script the <code>--rewrite--manifest</code> argument is fixed in the first or second argument.</p>
<p>OPTIONS</p>
<div class="codehilite"><pre><span></span><code>       --rewrite--manifest       enable leveldb startup optimization plugins，The above plug-in option `-d -m -b -h` will take effect iff this option(--rewrite--manifest) is turned on
</code></pre></div>

</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1"># Full command</span>
./start.sh<span class="w"> </span><span class="o">[</span>FullNode<span class="p">|</span>SolidityNode<span class="o">]</span><span class="w"> </span><span class="o">[</span>--rewrite--manifest<span class="o">]</span><span class="w"> </span><span class="o">[</span>-b<span class="w"> </span>batchSize<span class="o">]</span><span class="w"> </span><span class="o">[</span>-d<span class="w"> </span>databaseDirectory<span class="o">]</span><span class="w"> </span><span class="o">[</span>-m<span class="w"> </span>manifestSize<span class="o">]</span>
<span class="c1"># examples</span>
<span class="w">  </span>./start.sh<span class="w"> </span><span class="c1">#1. Start the FullNode.jar service without the plugin</span>
<span class="w">   </span>./start.sh<span class="w"> </span>SolidityNode<span class="w"> </span><span class="c1">#2. Start the SolidityNode.jar service without the plugin</span>
<span class="w">   </span>./start.sh<span class="w"> </span>FullNode<span class="w"> </span>--rewrite--manifest<span class="w"> </span><span class="c1">#3. Execute the optimization plugin with default settings and start the FullNode.jar service</span>
<span class="w">   </span>./start.sh<span class="w"> </span>--rewrite--manifest<span class="w"> </span>-d<span class="w"> </span>/tmp/db/database<span class="w"> </span><span class="c1">#4. Specify the database directory as /tmp/db/database, execute the optimization plugin, and start the FullNode.jar service</span>
<span class="w">   </span>./start.sh<span class="w"> </span>--rewrite--manifest<span class="w"> </span>-b<span class="w"> </span><span class="m">64000</span><span class="w"> </span><span class="c1">#5. Specify the batch size to 64000 when optimizing Manifest, and start the FullNode.jar service</span>
<span class="w">   </span>./start.sh<span class="w"> </span>--rewrite--manifest<span class="w"> </span>-m<span class="w"> </span><span class="m">128</span><span class="w"> </span><span class="c1">#6. Specify that optimization is performed only when the Manifest exceeds 128M, and start the FullNode.jar service</span>
</code></pre></div>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/tronprotocol/documentation-en" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
